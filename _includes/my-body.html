<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.11.5/dist/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.11.5/dist/ScrollTrigger.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/typeit@8.7.1/dist/index.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) {
    function e(e) {
      (console.error ? console.error : console.log).call(console, e)
    }

    function t(e) {
      return l.innerHTML = '<a href="' + e.replace(/"/g, "&quot;") + '"></a>', l.childNodes[0].getAttribute("href")
    }

    function r(e, t) {
      var r = e.substr(t, 2); return parseInt(r, 16)
    }

    function n(e, n) {
      for (var o = "", c = r(e, n), a = n + 2; a < e.length; a += 2) {
        var l = r(e, a) ^ c;
        o += String.fromCharCode(l)
      }
      return t(o)
    }

    var o = "/cdn-cgi/l/email-protection#",
      c = ".__cf_email__",
      a = "data-cfemail",
      l = document.createElement("div");

    !function () {
      for (var t = document.getElementsByTagName("a"), r = 0; r < t.length; r++)
        try {
          var c = t[r], a = c.href.indexOf(o);
          a > -1 && (c.href = "mailto:" + n(c.href, a + o.length))
        } catch (t) {
          e(t)
        }
    }(),
      function () {
        for (var t = document.querySelectorAll(c), r = 0; r < t.length; r++)
          try {
            var o = t[r], l = n(o.getAttribute(a), 0), i = document.createTextNode(l);
            o.parentNode.replaceChild(i, o)
          } catch (t) {
            e(t)
          }
      }()
  });
  console.log("JS running!");
  let cheeseInterval, typeitInstance, threeRAF, threeRenderer, threeCamera, threeScene;

  function initPage() {
    console.log("InitPage Triggered");
    if (cheeseInterval) { clearInterval(cheeseInterval); }
    if (typeitInstance) { typeitInstance.destroy(); }
    if (threeRAF) { cancelAnimationFrame(threeRAF); }

    // THREE.js background
    const canvas = document.getElementById('bgCanvas');
    if (!threeRenderer) {
      threeRenderer = new THREE.WebGLRenderer({ canvas, alpha: true });
      threeCamera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, .1, 1000);
      threeCamera.position.z = 5;
      threeScene = new THREE.Scene();
      const geo = new THREE.BufferGeometry(),
        pts = 5000,
        arr = new Float32Array(pts * 3);
      for (let i = 0; i < arr.length; i++) arr[i] = (Math.random() - .5) * 20;
      geo.setAttribute('position', new THREE.BufferAttribute(arr, 3));
      threeScene.add(new THREE.Points(
        geo,
        new THREE.PointsMaterial({ color: 0x00ff00, size: 0.05 })
      ));
      window.addEventListener('resize', onResize);
    }

    threeRenderer.setSize(innerWidth, innerHeight);

    function renderLoop() {
      threeRAF = requestAnimationFrame(renderLoop);
      threeScene.children[0].rotation.y += .0005;
      threeRenderer.render(threeScene, threeCamera);
    }
    renderLoop();

    function onResize() {
      threeRenderer.setSize(innerWidth, innerHeight);
      threeCamera.aspect = innerWidth / innerHeight;
      threeCamera.updateProjectionMatrix();
    }

    // TypeIt headline
    document.getElementById('typewriter').textContent = '';
    typeitInstance = new TypeIt('#typewriter', {
      strings: [
        'Game Designer',
        'Systems Designer',
        'Rapid Prototyper',
        'Level Designer',
        'Combat Systems Architect',
        'Prototype Developer'
      ],
      speed: 100,
      breakLines: false,
      loop: true
    }).go();

    // Cheese counter
    const cheeseEl = document.getElementById('cheeseCount');
    let cheese = Math.floor(Date.now() * 0.000001);
    cheeseEl.textContent = cheese;
    cheeseInterval = setInterval(() => cheeseEl.textContent = ++cheese, 2000);

    // AOS
    AOS.init({ duration: 800, offset: 100 });
  }

  document.addEventListener('DOMContentLoaded', initPage);
  window.addEventListener('load', initPage);
  window.addEventListener('pageshow', initPage);

</script>